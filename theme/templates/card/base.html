{% load static tailwind_tags %}
<!DOCTYPE html>
<html lang="en" class="notranslate" translate="no">
  <head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="google" content="notranslate" />
    <meta property="og:image" content="{% if card.user.image %}{{ card.user.image.url }}{% endif %}">
    <meta property="og:image:type" content="image/png">
    <meta property="og:image:width" content="1024">
    <meta property="og:image:height" content="1024">
    <meta property="og:type" content="website" />
    <meta property="og:url" content="{% url 'card' card.slug %}"/>
    <meta property="og:title" content="{{ card.user.first_name }} {{ card.user.last_name }}" />
    <meta property="og:description" content="{{ card.user.title }}" />
    <link rel="icon" type="image/png" href="{% static 'icons/favicon.png' %}">
    <title>Identicard</title>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    {% tailwind_css %}
    {% block css %}{% endblock css %}
    <script defer src="{% static 'js/base.js' %}"></script>
    {% block js %}{% endblock js %}
    <script defer src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js"></script>
  </head>
  <body>
    {% block content %}{% endblock content %}
    {% block video %}
      {% if card.video %}
        <div id="video" class="hidden fixed inset-0 justify-center items-center bg-gray-700 bg-opacity-60">
          <span class="material-icons absolute top-4 right-4 text-3xl text-white font-bold cursor-pointer">close</span>
          <iframe
            width="560"
            height="315"
            src="{{ card.video }}"
            title="YouTube video player"
            frameborder="0"
            allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
            allowfullscreen
          >
          </iframe>
        </div>
      {% endif %}
    {% endblock video %}
    {% if request.user.is_authenticated and request.user.pk == card.user.pk %}
      <a href="{% url 'dashboard' %}" target="_blank" class="material-icons text-4xl fixed right-5 bottom-20 md:bottom-5 text-gray-400">settings</a>
    {% endif %}
    <div id="splash-screen" class="fixed inset-0 bg-white flex justify-center items-center z-50">
      <svg class="spinner" viewBox="0 0 50 50">
        <circle class="path" cx="25" cy="25" r="20" fill="none" stroke-width="5"></circle>
      </svg>
    </div>
    {% include 'components/alerts/messages.html' %}
    {% url 'registration_id' card.pk as reg_url %}
    {{ reg_url|json_script:'regURL' }}
    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/9.1.2/firebase-app.js"
      import { getMessaging, getToken, onMessage } from "https://www.gstatic.com/firebasejs/9.1.2/firebase-messaging.js"
      // Your web app's Firebase configuration
      const firebaseConfig = {
        apiKey: "AIzaSyD4e-HPWUbN7QMVbKh43L69Yn6ktCzVUgk",
        authDomain: "identicard-328401.firebaseapp.com",
        projectId: "identicard-328401",
        storageBucket: "identicard-328401.appspot.com",
        messagingSenderId: "508686565862",
        appId: "1:508686565862:web:c65bbbfb742b05f9bf9627"
      }
      // Initialize Firebase
      const app = initializeApp(firebaseConfig)
      const msg = getMessaging()

      navigator.serviceWorker.register('/firebase-messaging-sw.js')
        .then(reg => {
          reg.update();
          getToken(msg, {vapidKey: 'BMF0cNAR7NGqlbs9gwLdCe4EhqGQNMKmLt2mgg9ffig_NBVpDQ_SOWYlUP1xa3iKiJ_2nERo746EDuufLK2XxpU'})
            .then(currentToken => {
              if (currentToken) {
                const regURL = JSON.parse(document.querySelector('#regURL').textContent)
                const formData = new FormData()
                formData.append('registration_id', currentToken)
                formData.append('csrfmiddlewaretoken', '{{ csrf_token }}')
                fetch(regURL, {
                  method: 'POST',
                  body: formData
                })
              } else {
                // Show permission request UI
                console.log('No registration token available. Request permission to generate one.')
                // ...
              }
            }).catch((err) => {
              console.log('An error occurred while retrieving token. ', err)
          });
        })

      onMessage(msg, (payload) => {
        const data = payload.data
        const notification = payload.notification
        // Customize notification here
        const notificationTitle = notification.title
        const notificationOptions = {
          body: notification.body,
          image: notification.image,
          icon: notification.icon,
          badge: notification.badge,
          data,
        }
        const n = new Notification(notificationTitle, notificationOptions)
        n.onclick = function(e) {
          e.preventDefault()
          const url = e.currentTarget.data.url
          window.open(url)
        }
      })

      let deferredPrompt = null

      const btnAdd = document.querySelector('#add-btn')

      window.addEventListener('beforeinstallprompt', function(e) {
        // Stash the event so it can be triggered later.
        deferredPrompt = e
      });

      // Installation must be done by a user gesture! Here, the button click
      btnAdd.addEventListener('click', (e) => {
        if (!deferredPrompt) return
        // Show the prompt
        deferredPrompt.prompt()
        // Wait for the user to respond to the prompt
        deferredPrompt.userChoice
          .then((choiceResult) => {
            if (choiceResult.outcome === 'accepted') {
              console.log('User accepted the A2HS prompt')
            } else {
              console.log('User dismissed the A2HS prompt')
            }
            deferredPrompt = null
          })
      })
    </script>
  </body>
</html>